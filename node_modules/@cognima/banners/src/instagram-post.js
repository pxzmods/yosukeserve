"use strict";

/**
 * M√≥dulo de Banner de Post do Instagram
 * 
 * Este m√≥dulo gera banners no estilo de posts do Instagram com suporte a
 * imagem principal, informa√ß√µes de usu√°rio e coment√°rios.
 * 
 * @author Cognima Team (melhorado)
 * @version 2.0.0
 */

Object.defineProperty(exports, "__esModule", { value: true });

const pureimage = require("pureimage");
const path = require("path");
const {
    loadImageWithAxios,
    encodeToBuffer,
    roundRect,
    wrapText,
    registerFontIfNeeded,
    isValidHexColor,
    DEFAULT_FONT_FAMILY,
    applyTextShadow,
    clearShadow,
    createLinearGradient,
    hexToRgba,
    formatNumber
} = require("../utils");

/**
 * @class InstagramPost
 * @classdesc Gera um banner no estilo de post do Instagram.
 * @example const postCard = new InstagramPost()
 * .setUsername("usuario_instagram")
 * .setUserAvatar("avatar.png")
 * .setImage("post.jpg")
 * .setCaption("Curtindo o dia na praia! #verao #ferias")
 * .setLikes(1250)
 * .addComment("amigo1", "Que lugar incr√≠vel!")
 * .build();
 */
module.exports = class InstagramPost {
  constructor(options) {
    // Dados Principais
    this.username = "usuario";
    this.userAvatar = null;
    this.verified = false;
    this.location = null;
    this.image = null;
    this.caption = null;
    this.likes = 0;
    this.comments = [];
    this.timestamp = "h√° 1 hora";

    // Personaliza√ß√£o Visual
    this.font = { name: options?.font?.name ?? DEFAULT_FONT_FAMILY, path: options?.font?.path };
    this.backgroundColor = "#FFFFFF";
    this.textColor = "#262626";
    this.secondaryTextColor = "#8e8e8e";
    this.accentColor = "#0095F6";
    this.showHeader = true;
    this.showFooter = true;
    
    // Configura√ß√µes de Layout
    this.cardWidth = 600;
    this.imageHeight = 600;
    this.cornerRadius = 0;
  }

  // --- Setters para Dados Principais ---
  /**
   * Define o nome de usu√°rio
   * @param {string} name - Nome do usu√°rio
   * @returns {InstagramPost} - Inst√¢ncia atual para encadeamento
   */
  setUsername(name) { 
    if (!name || typeof name !== "string") throw new Error("O nome de usu√°rio deve ser uma string n√£o vazia."); 
    this.username = name; 
    return this; 
  }
  
  /**
   * Define o avatar do usu√°rio
   * @param {string|Buffer|Object} image - URL, Buffer ou caminho da imagem do avatar
   * @returns {InstagramPost} - Inst√¢ncia atual para encadeamento
   */
  setUserAvatar(image) {
    if (!image) throw new Error("A fonte da imagem do avatar n√£o pode estar vazia.");
    this.userAvatar = image;
    return this;
  }
  
  /**
   * Define se o usu√°rio √© verificado
   * @param {boolean} isVerified - Se o usu√°rio √© verificado
   * @returns {InstagramPost} - Inst√¢ncia atual para encadeamento
   */
  setVerified(isVerified = true) {
    this.verified = !!isVerified;
    return this;
  }
  
  /**
   * Define a localiza√ß√£o do post
   * @param {string} location - Nome da localiza√ß√£o
   * @returns {InstagramPost} - Inst√¢ncia atual para encadeamento
   */
  setLocation(location) {
    if (!location || typeof location !== "string") throw new Error("A localiza√ß√£o deve ser uma string n√£o vazia.");
    this.location = location;
    return this;
  }
  
  /**
   * Define a imagem principal do post
   * @param {string|Buffer|Object} image - URL, Buffer ou caminho da imagem do post
   * @returns {InstagramPost} - Inst√¢ncia atual para encadeamento
   */
  setImage(image) {
    if (!image) throw new Error("A fonte da imagem do post n√£o pode estar vazia.");
    this.image = image;
    return this;
  }
  
  /**
   * Define a legenda do post
   * @param {string} text - Texto da legenda
   * @returns {InstagramPost} - Inst√¢ncia atual para encadeamento
   */
  setCaption(text) {
    if (!text || typeof text !== "string") throw new Error("A legenda deve ser uma string n√£o vazia.");
    this.caption = text;
    return this;
  }
  
  /**
   * Define o n√∫mero de curtidas
   * @param {number} count - N√∫mero de curtidas
   * @returns {InstagramPost} - Inst√¢ncia atual para encadeamento
   */
  setLikes(count) {
    if (typeof count !== "number" || count < 0) throw new Error("O n√∫mero de curtidas deve ser um n√∫mero n√£o negativo.");
    this.likes = count;
    return this;
  }
  
  /**
   * Adiciona um coment√°rio ao post
   * @param {string} username - Nome do usu√°rio que comentou
   * @param {string} text - Texto do coment√°rio
   * @returns {InstagramPost} - Inst√¢ncia atual para encadeamento
   */
  addComment(username, text) {
    if (!username || typeof username !== "string") throw new Error("O nome de usu√°rio do coment√°rio deve ser uma string n√£o vazia.");
    if (!text || typeof text !== "string") throw new Error("O texto do coment√°rio deve ser uma string n√£o vazia.");
    
    this.comments.push({ username, text });
    return this;
  }
  
  /**
   * Define o timestamp do post
   * @param {string} time - Texto do timestamp (ex: "h√° 2 horas")
   * @returns {InstagramPost} - Inst√¢ncia atual para encadeamento
   */
  setTimestamp(time) {
    if (!time || typeof time !== "string") throw new Error("O timestamp deve ser uma string n√£o vazia.");
    this.timestamp = time;
    return this;
  }

  // --- Setters para Personaliza√ß√£o Visual ---
  /**
   * Define a cor de fundo
   * @param {string} color - Cor hexadecimal
   * @returns {InstagramPost} - Inst√¢ncia atual para encadeamento
   */
  setBackgroundColor(color) { 
    if (!color || !isValidHexColor(color)) throw new Error("Cor de fundo inv√°lida. Use o formato hexadecimal."); 
    this.backgroundColor = color; 
    return this; 
  }
  
  /**
   * Define a cor do texto principal
   * @param {string} color - Cor hexadecimal
   * @returns {InstagramPost} - Inst√¢ncia atual para encadeamento
   */
  setTextColor(color) { 
    if (!color || !isValidHexColor(color)) throw new Error("Cor de texto inv√°lida. Use o formato hexadecimal."); 
    this.textColor = color; 
    return this; 
  }
  
  /**
   * Define a cor do texto secund√°rio
   * @param {string} color - Cor hexadecimal
   * @returns {InstagramPost} - Inst√¢ncia atual para encadeamento
   */
  setSecondaryTextColor(color) { 
    if (!color || !isValidHexColor(color)) throw new Error("Cor de texto secund√°rio inv√°lida. Use o formato hexadecimal."); 
    this.secondaryTextColor = color; 
    return this; 
  }
  
  /**
   * Define a cor de destaque
   * @param {string} color - Cor hexadecimal
   * @returns {InstagramPost} - Inst√¢ncia atual para encadeamento
   */
  setAccentColor(color) { 
    if (!color || !isValidHexColor(color)) throw new Error("Cor de destaque inv√°lida. Use o formato hexadecimal."); 
    this.accentColor = color; 
    return this; 
  }
  
  /**
   * Ativa ou desativa o cabe√ßalho
   * @param {boolean} show - Se o cabe√ßalho deve ser exibido
   * @returns {InstagramPost} - Inst√¢ncia atual para encadeamento
   */
  showHeader(show = true) {
    this.showHeader = show;
    return this;
  }
  
  /**
   * Ativa ou desativa o rodap√©
   * @param {boolean} show - Se o rodap√© deve ser exibido
   * @returns {InstagramPost} - Inst√¢ncia atual para encadeamento
   */
  showFooter(show = true) {
    this.showFooter = show;
    return this;
  }
  
  /**
   * Define as dimens√µes do card
   * @param {number} width - Largura do card em pixels
   * @returns {InstagramPost} - Inst√¢ncia atual para encadeamento
   */
  setCardWidth(width) {
    if (typeof width !== "number" || width < 400 || width > 1080) {
      throw new Error("A largura do card deve estar entre 400 e 1080 pixels.");
    }
    
    this.cardWidth = width;
    return this;
  }
  
  /**
   * Define a altura da imagem
   * @param {number} height - Altura da imagem em pixels
   * @returns {InstagramPost} - Inst√¢ncia atual para encadeamento
   */
  setImageHeight(height) {
    if (typeof height !== "number" || height < 400 || height > 1080) {
      throw new Error("A altura da imagem deve estar entre 400 e 1080 pixels.");
    }
    
    this.imageHeight = height;
    return this;
  }

  // --- M√©todo de Constru√ß√£o ---
  /**
   * Constr√≥i o banner e retorna um buffer de imagem
   * @returns {Promise<Buffer>} - Buffer contendo a imagem do banner
   */
  async build() {
    if (!this.image) throw new Error("A imagem do post deve ser definida usando setImage().");

    // --- Registro de Fonte ---
    const registeredFontName = await registerFontIfNeeded(this.font);

    // --- Configura√ß√£o do Canvas ---
    const cardWidth = this.cardWidth;
    const headerHeight = this.showHeader ? 60 : 0;
    const imageHeight = this.imageHeight;
    
    // Calcula a altura do rodap√© com base no conte√∫do
    let footerHeight = 0;
    if (this.showFooter) {
      footerHeight += 50; // √Årea de √≠cones e curtidas
      
      if (this.caption) {
        footerHeight += 60; // Espa√ßo para legenda
      }
      
      footerHeight += this.comments.length * 40; // Espa√ßo para coment√°rios
      footerHeight += 30; // Espa√ßo para timestamp
    }
    
    const cardHeight = headerHeight + imageHeight + footerHeight;
    const padding = 15;
    const avatarSize = 32;

    const canvas = pureimage.make(cardWidth, cardHeight);
    const ctx = canvas.getContext("2d");

    // --- Desenha Plano de Fundo ---
    ctx.fillStyle = this.backgroundColor;
    ctx.fillRect(0, 0, cardWidth, cardHeight);

    // --- Desenha Cabe√ßalho (se ativado) ---
    if (this.showHeader) {
      // Desenha linha divis√≥ria
      ctx.fillStyle = "#DBDBDB";
      ctx.fillRect(0, headerHeight - 1, cardWidth, 1);
      
      // Desenha avatar do usu√°rio
      if (this.userAvatar) {
        try {
          ctx.save();
          ctx.beginPath();
          ctx.arc(padding + avatarSize / 2, headerHeight / 2, avatarSize / 2, 0, Math.PI * 2);
          ctx.closePath();
          ctx.clip();
          
          const avatarImg = await loadImageWithAxios(this.userAvatar);
          ctx.drawImage(avatarImg, padding, headerHeight / 2 - avatarSize / 2, avatarSize, avatarSize);
          
          ctx.restore();
        } catch (e) {
          console.error("Falha ao desenhar avatar do usu√°rio:", e.message);
          
          // Avatar de fallback
          ctx.fillStyle = "#DBDBDB";
          ctx.beginPath();
          ctx.arc(padding + avatarSize / 2, headerHeight / 2, avatarSize / 2, 0, Math.PI * 2);
          ctx.fill();
          
          ctx.fillStyle = "#8e8e8e";
          ctx.font = `bold 16px ${registeredFontName}-Bold`;
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText("?", padding + avatarSize / 2, headerHeight / 2);
        }
      }
      
      // Desenha nome de usu√°rio
      ctx.fillStyle = this.textColor;
      ctx.font = `bold 14px ${registeredFontName}-Bold`;
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";
      
      const usernameX = padding + avatarSize + 10;
      ctx.fillText(this.username, usernameX, headerHeight / 2 - (this.location ? 7 : 0));
      
      // Desenha √≠cone de verificado (se aplic√°vel)
      if (this.verified) {
        const verifiedSize = 14;
        const verifiedX = usernameX + ctx.measureText(this.username).width + 5;
        
        ctx.fillStyle = this.accentColor;
        ctx.beginPath();
        ctx.arc(verifiedX + verifiedSize / 2, headerHeight / 2 - (this.location ? 7 : 0), verifiedSize / 2, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = "#FFFFFF";
        ctx.font = `bold 10px ${registeredFontName}-Bold`;
        ctx.textAlign = "center";
        ctx.fillText("‚úì", verifiedX + verifiedSize / 2, headerHeight / 2 - (this.location ? 7 : 0));
      }
      
      // Desenha localiza√ß√£o (se fornecida)
      if (this.location) {
        ctx.fillStyle = this.secondaryTextColor;
        ctx.font = `regular 12px ${registeredFontName}-Regular`;
        ctx.textAlign = "left";
        ctx.fillText(this.location, usernameX, headerHeight / 2 + 10);
      }
      
      // Desenha √≠cone de op√ß√µes
      ctx.fillStyle = this.textColor;
      ctx.font = `bold 18px ${registeredFontName}-Bold`;
      ctx.textAlign = "center";
      ctx.fillText("‚Ä¢‚Ä¢‚Ä¢", cardWidth - padding - 10, headerHeight / 2);
    }

    // --- Desenha Imagem Principal ---
    try {
      const img = await loadImageWithAxios(this.image);
      const aspect = img.width / img.height;
      let drawWidth = cardWidth;
      let drawHeight = drawWidth / aspect;
      
      // Ajusta as dimens√µes para manter a propor√ß√£o e preencher a altura desejada
      if (drawHeight < imageHeight) {
        drawHeight = imageHeight;
        drawWidth = drawHeight * aspect;
      }
      
      const offsetX = (cardWidth - drawWidth) / 2;
      const offsetY = headerHeight;
      
      ctx.drawImage(img, offsetX, offsetY, drawWidth, imageHeight);
    } catch (e) {
      console.error("Falha ao desenhar imagem principal:", e.message);
      
      // Imagem de fallback
      ctx.fillStyle = "#DBDBDB";
      ctx.fillRect(0, headerHeight, cardWidth, imageHeight);
      
      ctx.fillStyle = "#8e8e8e";
      ctx.font = `bold 24px ${registeredFontName}-Bold`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("Imagem n√£o dispon√≠vel", cardWidth / 2, headerHeight + imageHeight / 2);
    }

    // --- Desenha Rodap√© (se ativado) ---
    if (this.showFooter) {
      let currentY = headerHeight + imageHeight;
      
      // Desenha linha divis√≥ria
      ctx.fillStyle = "#DBDBDB";
      ctx.fillRect(0, currentY, cardWidth, 1);
      currentY += 1;
      
      // Desenha √≠cones de a√ß√£o
      const iconSize = 24;
      const iconSpacing = 15;
      let iconX = padding;
      
      // √çcone de curtir
      ctx.fillStyle = this.textColor;
      ctx.font = `bold ${iconSize}px Arial`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("‚ô°", iconX + iconSize / 2, currentY + 25);
      iconX += iconSize + iconSpacing;
      
      // √çcone de comentar
      ctx.fillText("üí¨", iconX + iconSize / 2, currentY + 25);
      iconX += iconSize + iconSpacing;
      
      // √çcone de compartilhar
      ctx.fillText("‚û§", iconX + iconSize / 2, currentY + 25);
      
      // √çcone de salvar (√† direita)
      ctx.fillText("‚äï", cardWidth - padding - iconSize / 2, currentY + 25);
      
      currentY += 50;
      
      // Desenha contador de curtidas
      ctx.fillStyle = this.textColor;
      ctx.font = `bold 14px ${registeredFontName}-Bold`;
      ctx.textAlign = "left";
      ctx.textBaseline = "top";
      ctx.fillText(`${formatNumber(this.likes)} curtidas`, padding, currentY);
      currentY += 25;
      
      // Desenha legenda (se fornecida)
      if (this.caption) {
        ctx.fillStyle = this.textColor;
        ctx.font = `bold 14px ${registeredFontName}-Bold`;
        ctx.textAlign = "left";
        ctx.fillText(this.username, padding, currentY);
        
        const usernameWidth = ctx.measureText(this.username).width;
        
        ctx.font = `regular 14px ${registeredFontName}-Regular`;
        const captionY = wrapText(ctx, this.caption, padding + usernameWidth + 5, currentY, cardWidth - padding * 2 - usernameWidth - 5, 18, registeredFontName);
        
        currentY = captionY;
      }
      
      // Desenha coment√°rios (se houver)
      if (this.comments.length > 0) {
        for (const comment of this.comments) {
          ctx.fillStyle = this.textColor;
          ctx.font = `bold 14px ${registeredFontName}-Bold`;
          ctx.textAlign = "left";
          ctx.fillText(comment.username, padding, currentY);
          
          const commentUsernameWidth = ctx.measureText(comment.username).width;
          
          ctx.font = `regular 14px ${registeredFontName}-Regular`;
          const commentY = wrapText(ctx, comment.text, padding + commentUsernameWidth + 5, currentY, cardWidth - padding * 2 - commentUsernameWidth - 5, 18, registeredFontName);
          
          currentY = commentY;
        }
      }
      
      // Desenha timestamp
      ctx.fillStyle = this.secondaryTextColor;
      ctx.font = `regular 12px ${registeredFontName}-Regular`;
      ctx.textAlign = "left";
      ctx.fillText(this.timestamp, padding, currentY);
    }

    // --- Codifica e Retorna Buffer ---
    try {
      return await encodeToBuffer(canvas);
    } catch (err) {
      console.error("Falha ao codificar o card de Post do Instagram:", err);
      throw new Error("N√£o foi poss√≠vel gerar o buffer de imagem do card de Post do Instagram.");
    }
  }
};

